<!DOCTYPE html>
<html>

<head>
    <title>Radar Data View</title>
    <script>
        // Define colors to mimic matplotlib's tab10 colormap used in the python matplot data plotting part of the python script that launches this webserver.
        const tab10Colors = [
            "#1f77b4", // blue
            "#ff7f0e", // orange
            "#2ca02c", // green
            "#d62728", // red
            "#9467bd", // purple
            "#8c564b", // brown
            "#e377c2", // pink
            "#7f7f7f", // gray
            "#bcbd22", // yellow-green
            "#17becf"  // cyan
        ];
        const clusterColors = {};

        async function fetchData() {
            const response = await fetch('/data');
            const data = await response.json();
            drawData(data);
        }

        // Assign a color for drawing all points within a unique cluster, if noise, draw it as a gray color.
        function assignClusterColor(data){
            for (let p of data.points) {
                const cid = p.cluster;
                if (!(cid in clusterColors)) {
                    clusterColors[cid] = cid >= 0 ? tab10Colors[cid % 10] : "gray";
                }
            }
        }

        function drawData(data) {
            const canvas = document.getElementById('radarCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const scale = 50; // 1 meter = 50 pixels
            const originX = canvas.width / 2;  // center horizontally
            const originY = canvas.height;     // bottom of canvas

            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let x = -5; x <= 5; x++) {
                const xPos = originX + x * scale;
                ctx.beginPath();
                ctx.moveTo(xPos, 0);
                ctx.lineTo(xPos, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= 8; y++) {
                const yPos = originY - y * scale;
                ctx.beginPath();
                ctx.moveTo(0, yPos);
                ctx.lineTo(canvas.width, yPos);
                ctx.stroke();
            }

            // Draw center vertical axis (Y) and bottom axis (X)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath(); // Y-axis
            ctx.moveTo(originX, 0);
            ctx.lineTo(originX, canvas.height);
            ctx.stroke();

            ctx.beginPath(); // X-axis
            ctx.moveTo(0, originY);
            ctx.lineTo(canvas.width, originY);
            ctx.stroke();

            // Draw axis markers (in meters)
            ctx.fillStyle = 'black';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            for (let x = -5; x <= 5; x++) {
                const xPos = originX + x * scale;
                ctx.fillText(`${x}`, xPos, originY - 2);
            }

            ctx.textAlign = 'left';
            for (let y = 1; y <= 8; y++) {
                const yPos = originY - y * scale;
                ctx.fillText(`${y}`, originX + 5, yPos + 3);
            }

            assignClusterColor(data);

            // Draw points
            // ctx.fillStyle = 'blue';
            for (let p of data.points) {
                const px = originX + p.x * scale;
                const py = originY - p.y * scale;
                ctx.beginPath();
                ctx.arc(px, py, 5, 0, 2 * Math.PI);
                ctx.fillStyle = clusterColors[p.cluster];
                ctx.fill();
            }

            // Draw cluster centroids
            ctx.fillStyle = '#000000';
            for (let c of data.clusters) {
                const cx = originX + c.x * scale;
                const cy = originY - c.y * scale;
                ctx.beginPath();
                ctx.arc(cx, cy, 7, 0, 2 * Math.PI);
                ctx.fill();
            }

            if (data.timestamp) {
                document.getElementById('timestamp').innerText =
                    "Last Update: " + new Date(data.timestamp * 1000).toLocaleTimeString();
            }
        }

        setInterval(fetchData, 500); // refresh every 0.5s
    </script>
</head>

<body>
    <h2>Radar Debug View</h2>
    <canvas id="radarCanvas" width="600" height="600" style="border:1px solid black;"></canvas>
    <p id="timestamp">Loading...</p>
</body>

</html>
